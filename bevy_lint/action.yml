name: Install `bevy_lint`
author: BD103
description: |
  Installs the Bevy linter and its required toolchain.

  This action currently uses Rustup to install the required toolchain components, and it uses
  `cargo install` to install the linter itself. The linter will be installed to `~/.cargo/bin` and
  will be available through the `PATH` by default.
runs:
  using: composite
  steps:
    # `dtolnay/rust-toolchain` overrides the default toolchain. We track what the original default
    # is and restore it afterwards.
    - name: Save original toolchain
      id: original-toolchain
      shell: bash
      # This may fail if Rustup is not installed, in which case we continue anyways.
      continue-on-error: true
      run: |
        # This prints what toolchain is installed, such as "stable-aarch64-apple-darwin (default)".
        DEFAULT="$(rustup default)"

        # We use `%` to strip "(default)" from the end of the output.
        echo "original-toolchain=${DEFAULT%(default)}" >> "${GITHUB_OUTPUT}"

    - name: Install Rust toolchain and components
      uses: dtolnay/rust-toolchain@master
      with:
        # This must be kept in sync with `rust-toolchain.toml`.
        toolchain: nightly-2025-04-03
        components: rustc-dev, llvm-tools-preview

    - name: Install `bevy_lint`
      shell: bash
      run: |
        # The toolchain must be kept in sync with `rust-toolchain.toml`. The `--branch main` should
        # be swapped with `--tag lint-vX.Y.Z` for releases.
        rustup run nightly-2025-04-03 cargo install \
          --git https://github.com/TheBevyFlock/bevy_cli.git \
          --branch main \
          --locked \
          bevy_lint

    - name: Restore original toolchain
      # If Rustup wasn't installed, causing `original-toolchain` to fail, we don't need to restore
      # the original toolchain since there wasn't one in the first place!
      if: ${{ steps.original-toolchain.outcome != 'failure' }}
      shell: bash
      env:
        ORIGINAL_TOOLCHAIN: ${{ steps.original-toolchain.outputs.original-toolchain }}
      run: rustup default "${ORIGINAL_TOOLCHAIN}"
