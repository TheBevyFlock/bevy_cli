# Coding Conventions and Best Practices

This document contains a list of conventions that `bevy_lint`'s code follows to ensure consistency across the project. Beyond this document, the project uses [Clippy], [`rustfmt`], and [`typos`] in CI, and it follows the majority of the [Rust API Guidelines].

[Clippy]: https://doc.rust-lang.org/clippy/
[`rustfmt`]: https://github.com/rust-lang/rustfmt
[`typos`]: https://github.com/crate-ci/typos
[Rust API Guidelines]: https://rust-lang.github.io/api-guidelines/

## Handle Macro-Generated Code in Lint Passes

When a developer uses a macro from a 3rd-party crate, it generates code that the developer cannot easily change or fix. Macro-generated code will still be linted, but if that code has any issues the developer cannot do anything to fix it beyond adding an `#[allow(...)]` attribute.

Because of this, all `bevy_lint` lint passes should skip code generated by an external macro. This can be done with [`Span::in_external_macro()`]:

```rust
impl<'tcx> LateLintPass<'tcx> for MyLint {
    fn check_expr(&mut self, cx: &LateContext<'tcx>, expr: &'tcx Expr<'tcx>) {
        // Do not lint this expression if it was generated by an external macro.
        if expr.span.in_external_macro(cx.tcx.sess.source_map()) {
            return;
        }

        // ...
    }
}
```

For more information, please see [Clippy's docs on macros], [the issue about macros], and [the PR that first incorporated these checks].

[`Span::in_external_macro()`]: https://doc.rust-lang.org/nightly/nightly-rustc/rustc_span/struct.Span.html#method.in_external_macro
[Clippy's docs on macros]: https://doc.rust-lang.org/stable/clippy/development/macro_expansions.html
[the issue about macros]: https://github.com/TheBevyFlock/bevy_cli/issues/167
[the PR that first incorporated these checks]: https://github.com/TheBevyFlock/bevy_cli/pull/263

## Avoid `HasSession`

[`HasSession`] is a trait in `clippy_utils` intended to make their API more friendly. `HasSession` provides the `sess()` method on `TyCtxt`, `LateContext`, and a few other types. `HasSession::sess()` should not be used within `bevy_lint` because [`Session`] is trivial to get without it, and `HasSession` requires an extra import.

```rust
use clippy_utils::source::HasSession;

fn late_context<'tcx>(cx: LateContext<'tcx>) {
    let sess = cx.sess();
}

fn ty_ctxt<'tcx>(tcx: TyCtxt<'tcx>) {
    let sess = tcx.sess();
}
```

Use instead:

```rust
fn late_context<'tcx>(cx: LateContext<'tcx>) {
    let sess = cx.tcx.sess;
}

fn ty_ctxt<'tcx>(tcx: TyCtxt<'tcx>) {
    let sess = tcx.sess;
}
```

[`HasSession`]: https://doc.rust-lang.org/nightly/nightly-rustc/clippy_utils/source/trait.HasSession.html
[`Session`]: https://doc.rust-lang.org/nightly/nightly-rustc/rustc_session/session/struct.Session.html
